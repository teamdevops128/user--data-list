
trigger:
- none

pool:
  vmImage: ubuntu-latest


steps:
- task: Bash@3
  inputs:
    targetType: 'inline'

- script: |
    #!/bin/bash

    #Purpose: To get the collaboratos in a csv by using , as a delimiter 
    
    ORG_NAME="sdevops713"
    OUTPUT_FILE="userdetails.csv"
    ORG_API="https://api.github.com/orgs/$ORG_NAME/repos"
    HEADER="Authorization: token $(TOKEN)"
    COLLABORATORS_API="https://api.github.com/repos/$ORG_NAME/{repo}/collaborators"
    echo "Repository Name,Collaborators" > "$OUTPUT_FILE"
    fetch_repos() {
    local page=1
    while true; do
        local repos=$(curl -s -H "$HEADER" "$ORG_API?page=$page&per_page=100" | jq '.[].name' -r)
        if [ -z "$repos" ]; then
            break
        fi
        for repo in $repos; do
            fetch_and_save_collaborators "$repo"
        done
        ((page++))
    done
    }
    fetch_and_save_collaborators() {
        local repo="$1"
        local collaborators=$(curl -s -H "$HEADER" "${COLLABORATORS_API/\{repo\}/$repo}" | jq -r '.[].login' | tr '\n' ';') # Combine collaborators with a semicolon
        echo "$repo,\"$collaborators\"" >> "$OUTPUT_FILE"
    }
    fetch_repos
    echo "Collaborator data saved to $OUTPUT_FILE"
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(System.DefaultWorkingDirectory)/userdetails.csv'
    artifact: 'myArtifacts'
    publishLocation: pipeline
  displayName: 'Publish Artifacts'